---
title: 远程读数据缓存设计详解
date: 2023-12-07 09:49:12
tags:
    - 数据缓存
categories:
    - CirroData
description: 详细说明远程读数据缓存功能设计
---

## 概述

计算节点通过缓存远端数据，实现了对数据的快速访问和网络开销的减少。当需要读取相同的数据时，计算节点可以直接从缓存中获取，而无需通过网络进行数据传输。这种方式不仅提高了数据访问的速度，也大大减少了网络的负载。这种策略在处理大量数据时，尤其能体现出其优势，有效提升了整体的运行效率。

## 缓存结构

### 元数据缓存(LRU缓存)

缓存所有CacheKey与CacheEntry的键值对，使用LRU缓存，用于查找数据，淘汰旧数据以及控制数据缓存占用磁盘的大小作用；

- CacheKey：记录远程文件的文件名filename，文件最后一次被修改的时间戳mtime，目标数据所在的起始偏移量offset
- CacheEntry：记录缓存数据所在的缓存文件的文件句柄，缓存数据所在的起始偏移量offset，缓存数据的长度length

### 数据缓存

存储从远端读取到的数据到本地磁盘中，当数据被存储时，无论数据实际占用多少空间，都会以4KB的倍数进行分配和存储。即以页（page）为单位进行管理, 有助于提高系统性能和文件打孔。

缺点：如果数据大小不是4KB的整数倍，会将整个4KB的页分配给数据，导致浪费一些空间。

- 存储目录：一个或多个，用于存储缓存文件，每个存储目录设置存储上限；多存储目录情况下在存储数据时，通过hash计算选择存储目录
- 缓存文件：存储具体的数据段，单文件最大可达到存储目录设置的存储上限，服务过程中保持open状态，属于临时文件，便于在服务停止或机器宕机后自动清理文件，避免产生垃圾文件

## 淘汰机制

1. 使用LRU策略淘汰旧数据，在删除CacheEntry的同时，通过文件打孔的方式，删除缓存文件中的旧数据
2. 限制总缓存文件数，避免因不断淘汰而产生大量小文件